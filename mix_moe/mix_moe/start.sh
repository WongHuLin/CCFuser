#!/bin/bash

cd /workspace/mix_moe/mix_moe

source /root/.bashrc

# IP_ADD="$1"
# PORT="$2"

export CUDA_LAUNCH_BLOCKING=1
lproc='4'
batch_size='1200'


export LD_LIBRARY_PATH=/workspace/local/nvshmem/lib:$LD_LIBRARY_PATH


mpirun --allow-run-as-root -np $lproc \
-H 127.0.0.1:4 \
-x MASTER_ADDR='127.0.0.1' \
-x MASTER_PORT='7777' \
-x PATH \
-bind-to none -map-by slot \
-mca pml ob1 -mca btl ^openib \
python test.py --backend=nccl  --batch-size=1200 


# mpirun --allow-run-as-root \
# -x LOCAL_SIZE=4 \
# -x PATH \
# -bind-to none \
# -host localhost \
# -map-by slot \
# -mca pml ob1 -mca btl ^openib \
# python3 -m tutel.launcher.run -m mix_moe.examples.mix_moe_ddp  --batch_size=16 --dtype=float16

# mpirun --allow-run-as-root -np 4 \
# -H 127.0.0.1:4 \
# -x MASTER_ADDR='127.0.0.1' \
# -x MASTER_PORT='7777' \
# -x LOCAL_SIZE=1 \
# -x PATH \
# -bind-to none \
# -host localhost \
# -map-by slot -mca pml ob1 -mca btl ^openib\
# python3 -m tutel.launcher.run -m mix_moe.examples.mix_moe_ddp  --batch_size=16 --dtype=float16

wait

# [   0,    0,    0,    0,   89,    0, 1009,    0,    0,    0,   10,  421,
#   777,    0,    0,    4,    0,    6,    1,    4, 1173,    7,    4,    0,
#     0,    0,    0,    0,    0,   13,   24,    0,   56, 1779,    0,    0,
#     0,   92,    0, 1287,    4,    5,    0,    4,    0,    0,    0,    0,
#     2,    0,    0,    4,    0,    0,    0,    0,  871,    0,   67,    0,
#    66,    0,  413,    0],
# [ 297,    0,    0,  801,    0,    0,    0,   44,    0,    8,   29,    0,
#     4,  279,   33, 1234, 1046,    0,    2,    4,    0,    1,    3,    5,
#     0,    4,    0,    0,    0,    2,    4,  112,    3,    0,   19,  104,
#     0,    1,    0,    0,   33,    5,    0,    0,    0,    0,    0,    0,
#   238,  962,    0,   22,    2,  255,  165,    1,  107, 1067,    0,  946,
#     1,  299,   22,   28],
# [   0,   87,    0,  106,  351,    1,    8,    5,    0,    0,    6,  312,
#   253,    0,    1,    0,    0,    0,    0,  835,   27,   12,  275,   25,
#     3,    7,    0,   49,    0,    0,    0,    9,    0,    0,  118,    4,
#     9, 1222,    0,   50,   19,    0,  470, 1570,   29,    1,  270,   52,
#    35,    1,  133,  124,    0,    0,  187,   26,    0,    2, 1050,    0,
#    28,  420,    0,    0],
# [   0,   19, 1336,  665,    8,    0,    0,    0,   46,  371,   56,    1,
#     0,    0,    1,  227,  184,  166,    0,    0,  470,    8,   24,    0,
#     0,    0,   81,   15,  277,    8,    0,    0,    0,   27,    2,  136,
#     0,    2,    0,    1,   57,    0,   29,    0,    0,   39,    0,    0,
#   171,    0,   30,   12,    0,    0,   35,    0,    5, 3339,    0,   79,
#     0,    1,  263,    1]

# 0: [33, 39, 20, 6, 56, 12, 11, 62, 60, 32, 30, 29, 18, 36, 5, 24], 
# 1: [15, 16, 49, 59, 3, 0, 13, 53, 48, 31, 7, 14, 63, 41, 23, 25], 
# 2: [43, 37, 58, 19, 42, 61, 4, 22, 46, 54, 50, 51, 34, 1, 47, 27], 
# 3: [57, 2, 9, 28, 17, 35, 26, 40, 10, 8, 45, 21, 38, 44, 52, 55]}

# [3648, 3203, 2122, 1949, 1500, 1372, 1173, 1054, 1018, 951, 900, 881, 691, 682, 672, 655, 595, 592, 582, 510, 471, 470, 460, 407, 401, 396, 379, 377, 352, 341, 282, 274, 270, 260, 182, 181, 160, 153, 145, 121, 108, 93, 87, 83, 81, 77, 71, 65, 64, 62, 55, 53, 51, 44, 43, 38, 37, 33, 32, 31, 30, 29, 29, 28, 27, 24, 23, 22, 22, 21, 21, 20, 20, 18, 18, 16, 16, 16, 16, 15, 15, 14, 14, 13, 13, 13, 13, 12, 12, 12, 11, 11, 11, 11, 10, 9, 8, 7, 6, 6, 6, 5, 5, 5, 4, 4, 4, 4, 4, 3, 3, 3, 3, 2, 2, 2, 2, 2, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
# [7, 25, 13, 12, 62, 18, 26, 4, 43, 21, 62, 19, 23, 11, 45, 53, 53, 20, 53, 38, 8, 52, 19, 53, 16, 43, 47, 12, 8, 56, 10, 36, 17, 60, 9, 60, 36, 55, 63, 41, 49, 18, 37, 62, 4, 50, 15, 28, 14, 44, 63, 18, 32, 28, 40, 54, 26, 59, 50, 57, 6, 13, 14, 37, 5, 21, 7, 0, 50, 46, 11, 20, 3, 41, 27, 32, 31, 44, 7, 46, 29, 10, 39, 40, 39, 30, 8, 51, 5, 43, 56, 24, 55, 1, 63, 58, 51, 0, 22, 32, 24, 33, 61, 51, 42, 33, 20, 34, 17, 26, 34, 9, 2, 56, 21, 47, 17, 31, 5, 17, 31, 16, 61, 15, 23, 11, 61, 43, 2, 61, 38, 29, 58, 22, 59, 19, 39, 62, 27, 28, 63, 0, 35, 4, 29, 13, 12, 31, 6, 9, 34, 7, 3, 10, 47, 48, 49, 50, 9, 52, 8, 44, 55, 57, 58, 59, 60, 2, 1, 22, 13, 42, 41, 40, 14, 37, 36, 35, 30, 49, 18, 27, 25, 24, 23, 4, 58, 3, 60, 1, 0, 1, 2, 3, 6, 5, 6, 59, 57, 10, 11, 12, 56, 25, 35, 33, 38, 40, 41, 42, 30, 45, 54, 23, 48, 22, 19, 16, 15, 54, 14, 44, 36, 37, 38, 39, 49, 48, 42, 47, 35, 45, 46, 48, 46, 52, 45, 54, 55, 26, 15, 16, 52, 51, 20, 21, 24, 25, 57, 27, 28, 29, 30, 32, 33, 34]
# [2, 0, 2, 1, 1, 3, 3, 1, 0, 3, 3, 0, 0, 3, 3, 2, 3, 0, 1, 3, 1, 1, 2, 0, 3, 3, 1, 0, 2, 2, 1, 1, 1, 0, 2, 2, 0, 1, 3, 0, 1, 2, 1, 0, 0, 1, 3, 1, 3, 0, 1, 1, 0, 3, 2, 3, 1, 1, 2, 1, 0, 1, 2, 0, 0, 1, 1, 1, 0, 3, 1, 3, 3, 2, 1, 3, 3, 1, 0, 1, 1, 3, 3, 0, 1, 0, 3, 3, 1, 2, 1, 1, 0, 3, 0, 0, 1, 2, 2, 1, 0, 0, 3, 2, 0, 3, 1, 1, 3, 0, 3, 1, 1, 3, 0, 2, 0, 1, 3, 2, 2, 0, 0, 0, 2, 0, 2, 1, 3, 1, 0, 3, 2, 0, 2, 3, 0, 2, 0, 0, 2, 3, 0, 3, 0, 3, 3, 0, 3, 3, 0, 3, 0, 0, 3, 3, 3, 3, 0, 3, 0, 3, 3, 3, 3, 3, 3, 0, 0, 3, 0, 3, 3, 3, 0, 3, 3, 3, 3, 2, 0, 3, 3, 3, 3, 2, 1, 1, 1, 1, 0, 2, 2, 2, 1, 2, 2, 0, 0, 2, 2, 2, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 0, 0, 2, 0, 2, 2, 2, 2, 0, 2, 0, 2, 2, 2, 2, 2, 0, 0, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2]

# [[3088, 1927, 964, 385, 314, 239, 129, 125, 118, 55, 47, 38, 29, 20, 11, 10], 
#  [0, 55, 25, 16, 0, 0, 0, 1, 0, 4, 0, 3, 14, 0, 0, 0], 
#  [38, 0, 0, 0, 0, 11, 9, 0, 0, 0, 0, 0, 13, 0, 9, 0], 
#  [0, 0, 268, 1, 10, 0, 0, 84, 0, 0, 0, 0, 0, 13, 0, 0]]

# [[0, 200, 0, 7, 6, 72, 12, 83, 4, 0, 0, 0, 0, 4, 0, 1], 
#  [29, 0, 0, 2, 0, 0, 0, 67, 25, 0, 39, 14, 0, 0, 0, 0], 
#  [2896, 2454, 499, 376, 369, 282, 235, 198, 108, 86, 77, 46, 41, 5, 1, 0], 
#  [66, 31, 0, 10, 0, 0, 0, 0, 0, 2, 0, 0, 3, 2, 0, 0]]

# [[0, 105, 1, 14, 4, 119, 0, 3, 15, 0, 0, 0, 0, 1, 0, 6], 
#  [2794, 1110, 1097, 546, 397, 221, 153, 129, 62, 56, 22, 13, 11, 2, 0, 0], 
#  [0, 13, 5, 35, 8, 0, 0, 0, 0, 0, 1, 0, 0, 1, 0, 0], 
#  [668, 7, 10, 0, 67, 3, 63, 51, 5, 0, 0, 0, 0, 0, 0, 0]]

# [[0, 0, 4, 13, 0, 0, 7, 0, 0, 0, 0, 1, 0, 9, 0, 2], 
#  [680, 0, 49, 496, 0, 0, 56, 0, 0, 0, 4, 0, 0, 0, 0, 0], 
#  [0, 46, 0, 275, 0, 2, 47, 0, 3, 0, 3, 0, 0, 0, 0, 0], 
#  [3204, 1145, 1027, 982, 194, 117, 95, 23, 14, 14, 7, 3, 2, 1, 0, 0]]